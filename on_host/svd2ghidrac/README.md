# svd2ghidrac

Converts SVD (System View Description) files, which describe the registers of ARM-based chips, to C headers parseable by Ghidra.

This simplifies the process of teaching Ghidra's decompiler about your chip's memory-mapped I/O registers, as it can generate data type libraries from the parsed C headers.

## Quick rundown

### Generating the CPU data type library

1. Open Ghidra's CodeBrowser without loading a file. (Click the dragon in the _Tool Chest_ in Ghidra's main window.)

2. If not already open, open the Data Type Manager by clicking _Window_ -> _Data Type Manager_.

3. Right-click all archives except _BuiltInTypes_ and close them.

4. Click _File_ -> _Parse C Source..._

5. Remove all entries from the list _Source files to parse_.

6. Add the CPU header for your device (e.g. `CM3.h`) to the now-empty list.

7. Add the option `-DGHIDRA_STDINT` at the bottom of the _Parse Options_ text field, on its own line.

8. Click _Parse to File..._

9. Choose a good location for the file. Name it after the CPU header with the `.gdt` extension, e.g. `CM3.gdt`.

### Generating the device data type library

1. Run `svd2ghidrac`. Supply the SVD file for your device as well as output locations for the C header and the structure JSON file. It is recommended to run a release build of `svd2ghidrac` to speed up the XML document tree navigation.

    cargo run --release --bin svd2ghidrac -- ATSAM3X8E.svd atsam3x8e.h atsam3x8e.json

2. Follow the steps in the previous section once more. Instead of loading the CPU header, load the device header generated in the previous step; name the `.gdt` file after the device header file (e.g. `atsam3x8e.gdt`).

### Loading a program

1. If necessary, create a new Ghidra project.

2. Import a binary by clicking _File_ -> _Import File..._

3. Open the binary in CodeBrowser by double-clicking it.

4. Perform analysis on the file.

5. Open the _Data Type Manager_ from the _Window_ menu.

6. Ensure that the data type archives for your CPU (e.g. `CM3`) and device (e.g. `atsam3x8e`) are both loaded. If not, click the downward-pointing triangle in the Data Type Manager title bar, select _Open File Archive..._ and open the file. The `SvdAddressSpace.py` script needs this to work correctly!

7. Open the _Script Manager_ from the _Window_ menu.

8. If you have not yet added the `ghidra_scripts` subdirectory of this project to your Ghidra script path, click the _Manage Script Directories_ button on the Script Manager title bar and then the plus icon in the _Bundle Manager_ title bar to do so.

9. Double-click the script `SvdAddressSpace.py`.

10. Choose the JSON file generated by `svd2ghidrac` in step 1.

Now the correct memory locations of your peripherals should be labeled.
